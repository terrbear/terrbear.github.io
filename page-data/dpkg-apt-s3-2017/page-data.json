{"componentChunkName":"component---src-templates-blog-post-js","path":"/dpkg-apt-s3-2017/","result":{"data":{"site":{"siteMetadata":{"title":"terrbear dot org"}},"markdownRemark":{"id":"d0ebdaaf-f4a5-56e4-a8af-0f76f53fd83b","excerpt":"Trying to make a Debian package and host it on S3 \nis and should be easy. But finding up to date examples and docs hasn’t been. \nSo, to save the next person some effort, here are some tools and ways to go about \nbuilding your own Debian package, signing it, and hosting it on S3 such that\nit can be installed with Apt, in 2017. You can follow along here: GitHub repo Authoring the Package Let’s make a currency bot service that logs the exchange rate of BTC and others \nusing rate.sx to /var/log/bubble. Also, just for fun (and demo purposes), on installation we should print the \ncurrent exchange…","html":"<p>Trying to make a Debian package and host it on <a href=\"https://aws.amazon.com/s3/\">S3</a>\nis and should be easy. But finding up to date examples and docs hasn’t been.\nSo, to save the next person some effort, here are some tools and ways to go about\nbuilding your own Debian package, signing it, and hosting it on S3 such that\nit can be installed with <a href=\"https://wiki.debian.org/Apt\">Apt</a>, in 2017.</p>\n<p>You can follow along here: <a href=\"https://github.com/terrbear/dpkg-example-2017\">GitHub repo</a></p>\n<h2>Authoring the Package</h2>\n<p>Let’s make a currency bot service that logs the exchange rate of BTC and others\nusing <a href=\"http://rate.sx\">rate.sx</a> to /var/log/bubble.</p>\n<p>Also, just for fun (and demo purposes), on installation we should print the\ncurrent exchange rate.</p>\n<p>To build the packages, you pass a directory to <a href=\"http://man7.org/linux/man-pages/man1/dpkg.1.html\">dpkg</a>\nthat has (1) a DEBIAN directory that has metadata about the package (dependencies, pre/post installation,\nversion info, etc) and (2) a map of what you want to lay out on the system.</p>\n<p>Here’s a layout of our currencybot:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span><span class=\"token number\">14</span>:47<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>theath@ego:~/code/dpkg-example/currencybot<span class=\"token punctuation\">]</span>$ <span class=\"token function\">ls</span> -lR\ntotal <span class=\"token number\">0</span>\ndrwxr-xr-x  <span class=\"token number\">4</span> theath  staff  <span class=\"token number\">136</span> Dec <span class=\"token number\">12</span> <span class=\"token number\">14</span>:47 DEBIAN\ndrwxr-xr-x  <span class=\"token number\">3</span> theath  staff  <span class=\"token number\">102</span> Dec <span class=\"token number\">12</span> <span class=\"token number\">14</span>:45 etc\n\n./DEBIAN:\ntotal <span class=\"token number\">16</span>\n-rw-r--r--  <span class=\"token number\">1</span> theath  staff  <span class=\"token number\">193</span> Dec <span class=\"token number\">12</span> <span class=\"token number\">14</span>:47 control\n-rwxr-xr-x  <span class=\"token number\">1</span> theath  staff   <span class=\"token number\">97</span> Dec <span class=\"token number\">12</span> <span class=\"token number\">14</span>:02 postinst\n\n./etc:\ntotal <span class=\"token number\">0</span>\ndrwxr-xr-x  <span class=\"token number\">3</span> theath  staff  <span class=\"token number\">102</span> Dec <span class=\"token number\">12</span> <span class=\"token number\">14</span>:46 cron.hourly\n\n./etc/cron.hourly:\ntotal <span class=\"token number\">8</span>\n-rw-r--r--  <span class=\"token number\">1</span> theath  staff  <span class=\"token number\">45</span> Dec <span class=\"token number\">12</span> <span class=\"token number\">14</span>:46 currency</code></pre></div>\n<p>DEBIAN/control is required to build a package. Here’s a bare-bones version for\ncurrencybot that shows it’s dependent on curl, and provides a bit of extra info\nfor anyone thinking about installing the package:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Package: currencybot\nVersion: $VERSION\nArchitecture: amd64\nMaintainer: terry heath &lt;theath@gmail.com&gt;\nDepends: curl\nHomepage: http://terrbear.org\nDescription: Documents the BTC excitement of 2017</code></pre></div>\n<p>Note the $VERSION. We’ll use that later with <a href=\"https://www.gnu.org/software/gettext/manual/html_node/envsubst-Invocation.html\">envsubst</a>\nto allow easy version revs.</p>\n<p>And, as mentioned above, the fun immediate print-out of exchange rates goes into\npostinst:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token function\">curl</span> rate.sx</code></pre></div>\n<p>Debian supports more install hooks than just postinst. You can read about all of\nthem at <a href=\"https://www.debian.org/doc/manuals/debian-faq/ch-pkg_basics.en.html\">Debian.org</a>.</p>\n<h2>Building the Package</h2>\n<p>Now that we have our package set up, we’ll need to use dpkg to build it. While\nI imagine there are ways to install dpkg on OSX, why would you when we have\n<a href=\"https://www.docker.com\">Docker</a>!?</p>\n<p>Here’s our Dockerfile, which takes a build arg to create whatever version we need:</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token keyword\">FROM</span> ubuntu\n\n<span class=\"token keyword\">ARG</span> version\n\n<span class=\"token keyword\">ENV</span> VERSION $<span class=\"token punctuation\">{</span>version<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">RUN</span> apt<span class=\"token punctuation\">-</span>get update &amp;&amp; \\\n    apt<span class=\"token punctuation\">-</span>get install <span class=\"token punctuation\">-</span>y gettext<span class=\"token punctuation\">-</span>base\n\n<span class=\"token keyword\">ADD</span> currencybot /currencybot<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>version<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">RUN</span> chmod +x /currencybot<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>version<span class=\"token punctuation\">}</span>/DEBIAN/postinst\n\n<span class=\"token keyword\">RUN</span> envsubst &lt; currencybot<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>version<span class=\"token punctuation\">}</span>/DEBIAN/control <span class=\"token punctuation\">></span> currencybot<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>version<span class=\"token punctuation\">}</span>/DEBIAN/control2 &amp;&amp; \\\n    mv currencybot<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>version<span class=\"token punctuation\">}</span>/DEBIAN/control2 currencybot<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>version<span class=\"token punctuation\">}</span>/DEBIAN/control\n\n<span class=\"token keyword\">RUN</span> dpkg <span class=\"token punctuation\">-</span>b currencybot<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>version<span class=\"token punctuation\">}</span>&lt;/code<span class=\"token punctuation\">></span>&lt;/pre<span class=\"token punctuation\">></span>&lt;/figure<span class=\"token punctuation\">></span>\n\nTo go with it<span class=\"token punctuation\">,</span> a friendly build script<span class=\"token punctuation\">:</span>\n\n&lt;figure class=<span class=\"token string\">\"highlight\"</span><span class=\"token punctuation\">></span>&lt;pre<span class=\"token punctuation\">></span>&lt;code class=<span class=\"token string\">\"language-bash\"</span> data<span class=\"token punctuation\">-</span>lang=<span class=\"token string\">\"bash\"</span><span class=\"token punctuation\">></span><span class=\"token comment\">#!/bin/bash</span>\n\nif <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">-</span>z <span class=\"token string\">\"$VERSION\"</span> <span class=\"token punctuation\">]</span>; then\n    echo <span class=\"token string\">\"No version supplied\"</span>\n    exit 1\nfi\n\ndocker build <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>build<span class=\"token punctuation\">-</span>arg version=$VERSION <span class=\"token punctuation\">-</span>t currencybot<span class=\"token punctuation\">:</span>deb<span class=\"token punctuation\">-</span>build . &amp;&amp; \\\ndocker create <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>name deb currencybot<span class=\"token punctuation\">:</span>deb<span class=\"token punctuation\">-</span>build &amp;&amp; \\\ndocker cp deb<span class=\"token punctuation\">:</span>/currencybot<span class=\"token punctuation\">-</span>$VERSION.deb ./currencybot<span class=\"token punctuation\">-</span>$VERSION.deb &amp;&amp; \\\ndocker rm <span class=\"token punctuation\">-</span>f deb</code></pre></div>\n<p>We’ll build the package like: <code class=\"language-text\">VERSION=1.0.0 ./build.sh</code></p>\n<p>After that, it’s good to try to install it at least once. I don’t have a good reason for this,\nbut I like <a href=\"https://www.vagrantup.com/\">Vagrant</a> for testing the installs. You could do this\nwith Docker as well though!</p>\n<p>(I’ve stripped out a bit of the nicer formatting because it translated poorly.)</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">ubuntu@ubuntu-xenial:/vagrant$ <span class=\"token function\">sudo</span> dpkg -i currencybot-1.0.0.deb\nSelecting previously unselected package currencybot.\n<span class=\"token punctuation\">(</span>Reading database <span class=\"token punctuation\">..</span>. <span class=\"token number\">53897</span> files and directories currently installed.<span class=\"token punctuation\">)</span>\nPreparing to unpack currencybot-1.0.0.deb <span class=\"token punctuation\">..</span>.\nUnpacking currencybot <span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span>.0<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">..</span>.\nSetting up currencybot <span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span>.0<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">..</span>.\n\nMarket Cap: <span class=\"token variable\">$497</span>,632,208,810 ↑\n24h Vol: <span class=\"token variable\">$37</span>,784,464,098 ↑\nBTC Dominance: <span class=\"token number\">58.8</span>% ↑\n┌──────┬───────┬─────────────┬──────────────┬─────────────┬──────────────────┬────────────┐\n│ Rank │ Coin  │ Price <span class=\"token punctuation\">(</span>USD<span class=\"token punctuation\">)</span> │ Change <span class=\"token punctuation\">(</span>24H<span class=\"token punctuation\">)</span> │ Change <span class=\"token punctuation\">(</span>1H<span class=\"token punctuation\">)</span> │ Market Cap <span class=\"token punctuation\">(</span>USD<span class=\"token punctuation\">)</span> │ Spark <span class=\"token punctuation\">(</span>1H<span class=\"token punctuation\">)</span> │\n├──────┼───────┼─────────────┼──────────────┼─────────────┼──────────────────┼────────────┤\n│ <span class=\"token number\">1</span>    │ BTC   │ <span class=\"token number\">17490.1</span>     │ <span class=\"token number\">1.41</span>%        │ <span class=\"token number\">0.19</span>%       │ <span class=\"token number\">292</span>.731B         │ ▁▁▇▂▁▅▂▁▁▃ │\n├──────┼───────┼─────────────┼──────────────┼─────────────┼──────────────────┼────────────┤\n│ <span class=\"token number\">2</span>    │ ETH   │ <span class=\"token number\">610.200</span>     │ <span class=\"token number\">27.67</span>%       │ -0.65%      │ <span class=\"token number\">58</span>.762B          │ ▅▁▂▃▁▇▃▁▂▁ │\n├──────┼───────┼─────────────┼──────────────┼─────────────┼──────────────────┼────────────┤\n│ <span class=\"token number\">3</span>    │ BCH   │ <span class=\"token number\">1632.96</span>     │ <span class=\"token number\">15.08</span>%       │ <span class=\"token number\">1.12</span>%       │ <span class=\"token number\">27</span>.518B          │ ▁▃▅▃▃▁▇▁▁▃ │\n├──────┼───────┼─────────────┼──────────────┼─────────────┼──────────────────┼────────────┤\n│ <span class=\"token number\">4</span>    │ LTC   │ <span class=\"token number\">331.171</span>     │ <span class=\"token number\">60.92</span>%       │ -1.20%      │ <span class=\"token number\">17</span>.974B          │ ▂▁▇▁▁▂▁▁▁▂ │\n├──────┼───────┼─────────────┼──────────────┼─────────────┼──────────────────┼────────────┤\n│ <span class=\"token number\">5</span>    │ XRP   │ <span class=\"token number\">0.375730</span>    │ <span class=\"token number\">49.85</span>%       │ <span class=\"token number\">8.02</span>%       │ <span class=\"token number\">14</span>.555B          │ ▁▁▁▂▁▁▁▃▁▇ │\n├──────┼───────┼─────────────┼──────────────┼─────────────┼──────────────────┼────────────┤\n│ <span class=\"token number\">6</span>    │ MIOTA │ <span class=\"token number\">4.59831</span>     │ <span class=\"token number\">5.93</span>%        │ <span class=\"token number\">1.50</span>%       │ <span class=\"token number\">12</span>.781B          │ ▁▁▁▂▁▁▅▁▇▁ │\n├──────┼───────┼─────────────┼──────────────┼─────────────┼──────────────────┼────────────┤\n│ <span class=\"token number\">7</span>    │ DASH  │ <span class=\"token number\">905.692</span>     │ <span class=\"token number\">20.63</span>%       │ -1.08%      │ <span class=\"token number\">7</span>.019B           │ ▇▁▇▂▁▁▅▁▃▁ │\n├──────┼───────┼─────────────┼──────────────┼─────────────┼──────────────────┼────────────┤\n│ <span class=\"token number\">8</span>    │ XEM   │ <span class=\"token number\">0.550592</span>    │ <span class=\"token number\">17.19</span>%       │ <span class=\"token number\">1.25</span>%       │ <span class=\"token number\">4</span>.955B           │ ▂▁▂▁▁▇▁▁▂▁ │\n├──────┼───────┼─────────────┼──────────────┼─────────────┼──────────────────┼────────────┤\n│ <span class=\"token number\">9</span>    │ XMR   │ <span class=\"token number\">305.197</span>     │ <span class=\"token number\">11.42</span>%       │ <span class=\"token number\">0.82</span>%       │ <span class=\"token number\">4</span>.715B           │ ▇▁▃▁▁▁▁▁▇▃ │\n├──────┼───────┼─────────────┼──────────────┼─────────────┼──────────────────┼────────────┤\n│ <span class=\"token number\">10</span>   │ BTG   │ <span class=\"token number\">272.704</span>     │ <span class=\"token number\">7.85</span>%        │ <span class=\"token number\">0.75</span>%       │ <span class=\"token number\">4</span>.555B           │ ▅▁▃▇▂▅▂▂▁▁ │\n└──────┴───────┴─────────────┴──────────────┴─────────────┴──────────────────┴────────────┘\n<span class=\"token number\">2017</span>-12-12 <span class=\"token number\">22</span>:05:02.849983 UTC\n\nSee rate.sx/:help <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span> and disclaimer\n<span class=\"token punctuation\">[</span>Follow @igor_chubin <span class=\"token keyword\">for</span> rate.sx updates<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>github.com/chubin/rate.sx<span class=\"token punctuation\">]</span></code></pre></div>","frontmatter":{"title":"Packaging dpkg for S3 in 2017","date":"December 12, 2017","description":null}}},"pageContext":{"slug":"/dpkg-apt-s3-2017/","previous":{"fields":{"slug":"/aws-lambda-error-handling/"},"frontmatter":{"title":"AWS Lambda Error Handling and Monitoring"}},"next":{"fields":{"slug":"/iot-power-button/"},"frontmatter":{"title":"AWS IoT EC2 Power Button"}}}}}