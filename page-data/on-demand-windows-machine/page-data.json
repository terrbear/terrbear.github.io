{"componentChunkName":"component---src-templates-blog-post-js","path":"/on-demand-windows-machine/","result":{"data":{"site":{"siteMetadata":{"title":"terrbear dot org"}},"markdownRemark":{"id":"428629fe-233f-53ac-8f1f-3d8952fa6c68","excerpt":"A few years back, my wife needed a new Windows machine. I didn’t want to get new\nhardware, so I convinced her to try out an EC2 instance instead. Instead of\nan EEEPC with an 8” screen, she got upgraded to a Macbook that would RDP into an\nEC2 instance.  Using a t3.large and an IoT button for powering on/off, this costs less than $10/month.\nIt takes up no space in the house, and the maintenance is almost zero. The workflow\nlooks like this: Push power button (IoT or iOS shortcut) -> trigger a lambda that starts the EC2 instance Wait 30 seconds Start RDP client into Windows machine (connectivity…","html":"<p>A few years back, my wife needed a new Windows machine. I didn’t want to get new\nhardware, so I convinced her to try out an EC2 instance instead. Instead of\nan EEEPC with an 8” screen, she got upgraded to a Macbook that would RDP into an\nEC2 instance. </p>\n<p>Using a t3.large and an IoT button for powering on/off, this costs less than $10/month.\nIt takes up no space in the house, and the maintenance is almost zero. The workflow\nlooks like this:</p>\n<ol>\n<li>Push power button (IoT or iOS shortcut) -> trigger a lambda that starts the EC2 instance</li>\n<li>Wait 30 seconds</li>\n<li>Start RDP client into Windows machine (connectivity is restricted by security groups)</li>\n<li>Profit</li>\n</ol>\n<br/>\n<p>Here’s how to do it.</p>\n<blockquote>\n<p><i class=\"fa fa-github\"></i> All the resources for this post can be found on <a href=\"https://github.com/terrbear/terrbear.github.io/tree/develop/content/blog/on-demand-windows-machine/resources\">GitHub</a>.</p>\n</blockquote>\n<h2>Overview</h2>\n<p>We’re going to stand up a CloudFormation stack that uses an Elastic IP to keep\nconnectivity save-able in the RDP client. The EC2 instance will have a security\ngroup that only allows ingress traffic from your WAN IP. I maintain that rule\nwith a cronjob that runs hourly:</p>\n<div class=\"gatsby-highlight\" data-language=\"cron\"><pre class=\"language-cron\"><code class=\"language-cron\">0 * * * * /usr/local/bin/aws cloudformation deploy --stack-name windows-box --template-file ~user/cloudformation/cf-auto-windows-box.yml --parameter-overrides &quot;ClientIP=$(curl ifconfig.co)&quot; --no-fail-on-empty-changeset</code></pre></div>\n<p>You’ll have to fill in your own VPC and subnet IDs for this stack - the host needs\ninternet access. Using this\n<a href=\"https://github.com/terrbear/terrbear.github.io/blob/develop/content/blog/on-demand-windows-machine/resources/cf-auto-windows-box.yml\">CloudFormation template</a>,\nyou can create the stack through the AWS console or just command-line it:</p>\n<blockquote>\n<p><i class=\"fas fa-lightbulb\"></i> <a href=\"https://ifconfig.co\">ifconfig.co</a> is handy for grabbing your WAN IP</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws cloudformation deploy <span class=\"token punctuation\">\\</span>\n  --stack-name windows-box <span class=\"token punctuation\">\\</span>\n  --template-file cf-auto-windows-box.yml <span class=\"token punctuation\">\\</span>\n  --capabilities CAPABILITY_NAMED_IAM <span class=\"token punctuation\">\\</span>\n  --parameter-overrides <span class=\"token punctuation\">\\</span>\n    <span class=\"token string\">\"KeyPair=YOUR-KEY-NAME\"</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token string\">\"VPC=YOUR-VPC-ID\"</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token string\">\"Subnet=YOUR-SUBNET-ID\"</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token string\">\"ClientIP=<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> ifconfig.co<span class=\"token variable\">)</span></span>\"</span></code></pre></div>\n<h2>The Lambdas</h2>\n<p>The template adds two lambdas to your account, <code class=\"language-text\">power-switch</code> and <code class=\"language-text\">power-off</code>. </p>\n<p>The <code class=\"language-text\">power-switch</code> lambda toggles the state from stopped to running:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">AWS</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"aws-sdk\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> instanceId <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">INSTANCE_ID</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> ec2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AWS<span class=\"token punctuation\">.</span>EC2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">checkIfRunning</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> ec2\n    <span class=\"token punctuation\">.</span><span class=\"token function\">describeInstances</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> InstanceIds<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>instanceId<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>Reservations<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Instances<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>State<span class=\"token punctuation\">.</span>Name <span class=\"token operator\">!==</span> <span class=\"token string\">\"stopped\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">handler</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    InstanceIds<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>instanceId<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> running <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">checkIfRunning</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> ec2<span class=\"token punctuation\">.</span><span class=\"token function\">stopInstances</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> ec2<span class=\"token punctuation\">.</span><span class=\"token function\">startInstances</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The <code class=\"language-text\">power-off</code> lambda, unsurprisingly, always turns the machine off:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">AWS</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"aws-sdk\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> instanceId <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">INSTANCE_ID</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> ec2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AWS<span class=\"token punctuation\">.</span>EC2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">handler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    InstanceIds<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>instanceId<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> ec2<span class=\"token punctuation\">.</span><span class=\"token function\">stopInstances</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The lambdas will only be allowed to describe your EC2 instances and turn on/off the instance created as part of the stack.</p>\n<h2>Flipping the switch</h2>\n<p>Thanks to iOS’s Shortcuts allowing SSH commands, you can actually make a nifty power switch from your phone:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 296px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/130e0fe0f0511caddc9621c90db7fd13/b1a44/ios-switch.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 216.2162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAArCAIAAAD3xz8iAAAACXBIWXMAAAsSAAALEgHS3X78AAAEsUlEQVRIx4VWWXPbNhDWH2t+UP9IzxnH40md1Gk7zUz7lJk+9bXH2FZtOZZqyzpIihQPkQQJHiBFiFT70g8A5cqy7KyX8ALYxS4We6gTksS0nH7/djqdLRYkDGkQxE8gddzAthd3d9PBYEhI0sFnGPOzswvMPS98Rhhbmm7qunl50fv9tz/iOOvI1YQmLI5znK00YPT3yUMTLJ15hR0sfT+GMI2iDKf6fqTUYhUcWMSKOiWKUigAJwmp59M/b5LrSbzwaQd7k4lhWi7MgNkkSilljuPDBSAISWER7uW6AQ5y3ZAEZGQl3XFCwriD1YODw8PDo+Pjbz//4qujo2+Oj9+8e/fTq1fHJyffYf3165P3738B8fbtD19+/fLHN0effj9/cVjDNqEZenTdGo/14XCiRkyxqKawy7Lc0UiDLfCzNtVvddKb4iIxvE1d18uyvChKYFkuq4pjZEVZVSvQclphXC4556slVsqiKjISiaeKP3y4xhOlmYBltfwH8C++Nd8LK5xSRTGlNO1Qmk1gmWHouj6dTkFoun57e6tpGn8CKpywWrXChJCFBNuxPc/zfd/BjYOAPw11XQvhJMlw0ZyxUt5svV43TaPGar9acFVgboUZY1RCmmZiewN7FQJgcyuMjyI601St8mchTVOpI2UFazVbljWbzfhHBIWT5vM5HAlm13NpkgmHLSW099ly6Y7l2L03G1utt3GYaZoftVnJgw0+gvJWuG5qLg+rpML/NctZtTOV0L4z7qzCY9XKV88/bxzHNzc3tm2naS6ElcH1BnbufH9zRYABDmrvjAOMmXF52Rv8Pej3+8PhcJsboeJ5i7Oz8273r+HdyJrPu93u9XU/EQBvJyIwZDJVTEK1FUkgiqJIEAZQkmfLkrE8y7MUmaXujEJhIBNwbRXxj58XpjZNnRb12Kv1oDbC2k9rnCjuXCBcEpSoAPnIH3h7Q1e8lt5MGM9LnhVVXm687Tg2lItMeAJWvEryygy4G3Mv5rOAh+mq1RxFEdKweQioBmqEzcgxXq+jfJ0UwAbyNF8lSjOeDuEN5bg23lzRcDteYTQaIc9Ny5pMxvbcnBma48xxVNO0xSDFRu/qCtx4kMFg0OthdoUjUJUiFN48h6uhIBEpJfz+oJLg0fEepRwVjUK4cXKzqltCBFDTRhEWN7EtE2UH2jB+5Pxqu4bhziox9smv9q4Lo5paRBiJKMxkbBdzVvAlA+Zszy4ABb+Dboa2vIPegqAnDbQICMJ7xACEYCcIqWiOGww3ox/QTw74i5c83GKQbXTDHNDOpic/+AUg+i6JP/uVAWMSb/FsMwuz4wcoN0BgZDQC3jf6+9EPWmY8FTIz3YsxFQgCoQG2bUSFx4hikOq6oWmoRCiEumHMBH1PoKVONcuaoySgmWIE2rYzHk+Q1kIYE2ybJuoEapMDYiZpLCp0HNdH70L2+BgCyKvg7TD5auUGtuntRYSCSHwREa0A/gvhkBAcI15fPD2BD5AM2Rag9EQJO9fLOC2qkoH++aJEjxPCYFXnAcF63yubteiXqmniBwFJWCaUgp+RpGg1K2PUiKxCSp+enqJKnuNPAqai11dLabTQIq1m/wEs1C/cDwwUdAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"iOS Shortcut\"\n        title=\"iOS Shortcut\"\n        src=\"/static/130e0fe0f0511caddc9621c90db7fd13/b1a44/ios-switch.png\"\n        srcset=\"/static/130e0fe0f0511caddc9621c90db7fd13/12f09/ios-switch.png 148w,\n/static/130e0fe0f0511caddc9621c90db7fd13/e4a3f/ios-switch.png 295w,\n/static/130e0fe0f0511caddc9621c90db7fd13/b1a44/ios-switch.png 296w\"\n        sizes=\"(max-width: 296px) 100vw, 296px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>If you end up going the iOS shortcut route, you can skip the cronjob and issue the CloudFormation update\nwith your current IP as needed. </p>\n<p>Unfortunately, there isn’t a way to get the IP address of an IoT button when it’s pressed, so I’m still\nusing the cronjob. </p>\n<p>If you just want to test this out without using the AWS console, you can invoke the lambda like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws lambda invoke --function-name power-switch /dev/null</code></pre></div>\n<h2>Cost Control</h2>\n<p>The <code class=\"language-text\">power-off</code> lambda is used to prevent the machine from running too long. The stack\nwill schedule it to run once per day. You’ll want to change the cron expression to match\nyour timezone (in Pacific/Auckland I’ve got it set to 1am-ish).</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">PowerOffNightlyRule</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> AWS<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Events<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Rule\n  <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">Name</span><span class=\"token punctuation\">:</span> power<span class=\"token punctuation\">-</span>off<span class=\"token punctuation\">-</span>nightly\n    <span class=\"token key atrule\">Description</span><span class=\"token punctuation\">:</span> powers off the instance daily\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token key atrule\">ScheduleExpression</span><span class=\"token punctuation\">:</span> cron(0 13 * * <span class=\"token punctuation\">?</span> <span class=\"token important\">*)</span></span>    <span class=\"token key atrule\">State</span><span class=\"token punctuation\">:</span> ENABLED\n    <span class=\"token key atrule\">Targets</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Arn</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!GetAtt</span> PowerOff.Arn\n        <span class=\"token key atrule\">Id</span><span class=\"token punctuation\">:</span> PowerOffNightly</code></pre></div>\n<h2>Wrapping Up</h2>\n<p>We’ve had this setup running for a few years now. Moving from Austin to Wellington made\nthe latency painful, so I recently recreated the instance in Sydney (it was in us-east-1).</p>\n<p>Maintenance has been, as mentioned, light. I changed the instance type from T2 to T3\nwithout any hiccups. We keep EBS snapshots around, and the OSX RDP client is pretty solid -\nshe can mount USB drives and drag files to/from the instance.</p>\n<p>Even at her peak usage, this started in 2018, so generously 24 months at $10/month is $240.\nAn actual machine with the same specs would have cost significantly more :)</p>","frontmatter":{"title":"On Demand Windows Machine in AWS","date":"May 03, 2020","description":null}}},"pageContext":{"slug":"/on-demand-windows-machine/","previous":{"fields":{"slug":"/opt-in-previews-with-albs/"},"frontmatter":{"title":"Opting in to Preview Builds with AWS ALBs"}},"next":null}}}