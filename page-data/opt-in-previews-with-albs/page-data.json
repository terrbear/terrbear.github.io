{"componentChunkName":"component---src-templates-blog-post-js","path":"/opt-in-previews-with-albs/","result":{"data":{"site":{"siteMetadata":{"title":"terrbear dot org"}},"markdownRemark":{"id":"2d769f74-b643-5b86-8f6d-e7ef41627baf","excerpt":"AWS’s application load balancers \nsupport routing traffic to different locations based on \nHTTP request characteristics. \nThis is helpful if you want to allow users to opt-in to use a new service. Typically I’ve used feature flags to determine if a user should see new features, but\nfeature flags are hard to manage when the feature affects a huge surface area. In this case,\nit can be easier to host an old and new version of the service side-by-side. You can gently bring \nusers into your new features and easily fall back to the old app if something is missing. To let users opt-in, let’s build a…","html":"<p>AWS’s <a href=\"https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html\">application load balancers</a>\nsupport routing traffic to different locations based on\n<a href=\"https://docs.aws.amazon.com/elasticloadbalancing/latest/application/listener-update-rules.html\">HTTP request characteristics</a>.\nThis is helpful if you want to allow users to opt-in to use a new service.</p>\n<p>Typically I’ve used feature flags to determine if a user should see new features, but\nfeature flags are hard to manage when the feature affects a huge surface area. In this case,\nit can be easier to host an old and new version of the service side-by-side. You can gently bring\nusers into your new features and easily fall back to the old app if something is missing.</p>\n<p>To let users opt-in, let’s build a workflow like this:</p>\n<ol>\n<li>User goes to mysite.com, sees original service.</li>\n<li>Original site shows a button that lets them opt-in to the new service.</li>\n<li>When they click the button, a cookie is written. We’ll set it as <code class=\"language-text\">preview=yes</code>.</li>\n<li>Then the browser refreshes (<code class=\"language-text\">window.location.reload()</code>), re-requesting mysite.com. The ALB sees the preview cookie, and directs traffic to the new service.</li>\n<li>We’ll support opt-out by allowing the new service to delete the cookie.</li>\n</ol>\n<h2>Step 1: Make a service that allows opt-in</h2>\n<blockquote>\n<p><i class=\"fa fa-github\"></i> All the resources for this post can be found on <a href=\"https://github.com/terrbear/terrbear.github.io/tree/develop/content/blog/opt-in-previews-with-albs\">GitHub</a>.</p>\n</blockquote>\n<p>I’ve made what I think is the simplest proof of concept here:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">preview</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> expires <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      expires<span class=\"token punctuation\">.</span><span class=\"token function\">setMonth</span><span class=\"token punctuation\">(</span>expires<span class=\"token punctuation\">.</span><span class=\"token function\">getMonth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">%</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      document<span class=\"token punctuation\">.</span>cookie <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">preview=yes; expires=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>expires<span class=\"token punctuation\">.</span><span class=\"token function\">toUTCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">; path=/</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n      window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span><span class=\"token function\">reload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n    You're in the original build. Click here to use the preview! \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>preview()<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>Let's do it<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Again, the idea is to let the user write a preview cookie and get a different app. This will\nset a cookie that’ll expire in a month, at which point the user will get sent back to the original service.</p>\n<h2>Step 2: Make a preview service that allows opts-out</h2>\n<p>Our super-advanced preview service that’ll only show up for users who want to opt in:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">unpreview</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      document<span class=\"token punctuation\">.</span>cookie <span class=\"token operator\">=</span> <span class=\"token string\">\"preview=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/\"</span><span class=\"token punctuation\">;</span>\n      window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span><span class=\"token function\">reload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n    You're in the preview build! <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>unpreview()<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>Take me back!<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>The button just deletes the cookie and reloads the page.</p>\n<h2>Step 3: Create the stack</h2>\n<blockquote>\n<p><i class=\"fab fa-docker\"></i> The Docker containers are built using this <a href=\"https://github.com/terrbear/terrbear.github.io/blob/develop/content/blog/opt-in-previews-with-albs/Dockerfile\">Dockerfile</a>, if you want to create them yourself.</p>\n</blockquote>\n<p>This is the CloudFormation snippet that will create the ALB rules.</p>\n<p>Note that the cookie handling uses wildcards to allow for other cookie values in there.</p>\n<p>I’ve also added an <code class=\"language-text\">x-preview</code> header to make API interactions easier. Note that the “yes”\nfor the header value is in quotes because YAML is “helpful.”</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">PreviewCookieRule</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> AWS<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>ElasticLoadBalancingV2<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>ListenerRule\n  <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span> \n    <span class=\"token key atrule\">Actions</span><span class=\"token punctuation\">:</span> \n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> forward\n        <span class=\"token key atrule\">TargetGroupArn</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!Ref</span> PreviewTargetGroup\n    <span class=\"token key atrule\">Conditions</span><span class=\"token punctuation\">:</span> \n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Field</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">-</span>header\n        <span class=\"token key atrule\">HttpHeaderConfig</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">HttpHeaderName</span><span class=\"token punctuation\">:</span> cookie\n          <span class=\"token key atrule\">Values</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token string\">\"*preview=yes*\"</span>\n    <span class=\"token key atrule\">ListenerArn</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!Ref</span> HTTPListener\n    <span class=\"token key atrule\">Priority</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n\n<span class=\"token key atrule\">PreviewHeaderRule</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> AWS<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>ElasticLoadBalancingV2<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>ListenerRule\n  <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span> \n    <span class=\"token key atrule\">Actions</span><span class=\"token punctuation\">:</span> \n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> forward\n        <span class=\"token key atrule\">TargetGroupArn</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!Ref</span> PreviewTargetGroup\n    <span class=\"token key atrule\">Conditions</span><span class=\"token punctuation\">:</span> \n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Field</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">-</span>header\n        <span class=\"token key atrule\">HttpHeaderConfig</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">HttpHeaderName</span><span class=\"token punctuation\">:</span> x<span class=\"token punctuation\">-</span>preview\n          <span class=\"token key atrule\">Values</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token string\">\"yes\"</span>\n    <span class=\"token key atrule\">ListenerArn</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!Ref</span> HTTPListener\n    <span class=\"token key atrule\">Priority</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span></code></pre></div>\n<p>Essentially the load balancer is set up to forward traffic to OriginalTargetGroup, but then\nwe add these rules to tell it that, if either of our rules match, forward to PreviewTargetGroup instead.</p>\n<p>Assuming you have a VPC set up with a couple public subnets and an ECS cluster, you can run something like\nthis:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">aws cloudformation create-stack <span class=\"token punctuation\">\\</span>\n  --stack-name example <span class=\"token punctuation\">\\</span>\n  --template-body <span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> cf-preview.yml<span class=\"token variable\">)</span></span>\"</span> <span class=\"token punctuation\">\\</span>\n  --capabilities CAPABILITY_NAMED_IAM <span class=\"token punctuation\">\\</span>\n  --parameters <span class=\"token assign-left variable\">ParameterKey</span><span class=\"token operator\">=</span>VPC,ParameterValue<span class=\"token operator\">=</span><span class=\"token variable\">$VPCID</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token assign-left variable\">ParameterKey</span><span class=\"token operator\">=</span>Subnet1,ParameterValue<span class=\"token operator\">=</span><span class=\"token variable\">$Subnet1ID</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token assign-left variable\">ParameterKey</span><span class=\"token operator\">=</span>Subnet2,ParameterValue<span class=\"token operator\">=</span><span class=\"token variable\">$Subnet2ID</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token assign-left variable\">ParameterKey</span><span class=\"token operator\">=</span>Cluster,ParameterValue<span class=\"token operator\">=</span><span class=\"token variable\">$ECSClusterName</span></code></pre></div>\n<p>If not, you’ll have to go by my screenshots.</p>\n<p>In AWS, after, the stack is created, you’ll be able to see how the ALB rules dictate traffic flow:</p>\n<blockquote>\n<p><i class=\"fas fa-exclamation-triangle\"></i> If you use a header like this for XHR requests coming from a different origin, remember to update your allowed CORS headers or your requests will be quietly routed to the old service.</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/45a4c5c0ffcad214d21103a86f022d5d/aea0a/rules.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.83783783783784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABk0lEQVQ4y4WT6W7bQAyE9f5P1/xpkSCBU8m6rNOyJUu+pvsxoWOkSbvAgHtwZ4ZLKUqSROtkLYvrtdI0VZ7nhs1mo7Is/wnyuJskseLAE/V9r6ZpVNe1xXEctdvtdDgcNM+zgfl38JxlWbSEGO33e0G63W41DIOqqjJF5lw4nU46n89/gX0/8/kpzCMutW1rpF3XGbGDNeeouxPH8Xg0fN6PLpeLqXDxer1apGwvZ5qmG6kDNz3ifafLGXdv5JxFCgMiiBm8nzeE8nl4KkAE8ETzfFCWl3r49azfeau8rFWHXM5vDgFzV/IIcIhTxxzWQxCu6kZFGb6EIO6NjJyEROa8HQ7pOg5xd0+GC0SyLNPqNdY0L5oCEc45t5LvB8mokeDxMyFOun7Q0yrV4yrTa5xayUbIA3MJR3QaEj4Z9hz3hFZycNWE/LapdJxp2mRGbg5RpQnurigKWwOEIP1oymjdz4pSP36+KC5aZWUV8t6b4l3Gqcf7T+SrP4W9cZxUNa2KDW/9JmpNgQT48PX/8NVg/w+rOurTMTZ4CQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ALB Rules\"\n        title=\"ALB Rules\"\n        src=\"/static/45a4c5c0ffcad214d21103a86f022d5d/fcda8/rules.png\"\n        srcset=\"/static/45a4c5c0ffcad214d21103a86f022d5d/12f09/rules.png 148w,\n/static/45a4c5c0ffcad214d21103a86f022d5d/e4a3f/rules.png 295w,\n/static/45a4c5c0ffcad214d21103a86f022d5d/fcda8/rules.png 590w,\n/static/45a4c5c0ffcad214d21103a86f022d5d/efc66/rules.png 885w,\n/static/45a4c5c0ffcad214d21103a86f022d5d/c83ae/rules.png 1180w,\n/static/45a4c5c0ffcad214d21103a86f022d5d/aea0a/rules.png 2018w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Seeing it in action</h2>\n<p>Here’s the original site:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5a9003cc5e24249d8fe6525d5d7047ff/91f10/original.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.27027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAlUlEQVQY061OSQ6EMAzr/x/GnBjOVOxLSxeQ4MQJj2yJH0wkK64dNzFl+UVRfFBVFUII2Pcdy7IIbduirmtYa9VfUD/PE+u6YpomeO/Fm6aB6fsexDAMGMdRnW+aXdcpTH2eZ4XpsRPOOS2ml1JCjBHmui6RnLNEmryUW4/jkLZtmy7nDDnBzH3fupR/vGXwp3qeR/gBjE8sIeX9sFYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Original\"\n        title=\"Original\"\n        src=\"/static/5a9003cc5e24249d8fe6525d5d7047ff/fcda8/original.png\"\n        srcset=\"/static/5a9003cc5e24249d8fe6525d5d7047ff/12f09/original.png 148w,\n/static/5a9003cc5e24249d8fe6525d5d7047ff/e4a3f/original.png 295w,\n/static/5a9003cc5e24249d8fe6525d5d7047ff/fcda8/original.png 590w,\n/static/5a9003cc5e24249d8fe6525d5d7047ff/efc66/original.png 885w,\n/static/5a9003cc5e24249d8fe6525d5d7047ff/91f10/original.png 992w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">~❯ <span class=\"token function\">curl</span> http://example-load-balancer-55775428.us-east-1.elb.amazonaws.com\n<span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>script <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"text/javascript\"</span><span class=\"token operator\">></span>\n    const preview <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n      const expires <span class=\"token operator\">=</span> new Date<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      expires.setMonth<span class=\"token punctuation\">(</span>expires.getMonth<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> + <span class=\"token number\">1</span> % <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      document.cookie <span class=\"token operator\">=</span> <span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token assign-left variable\">preview</span><span class=\"token operator\">=</span>yes<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">expires</span><span class=\"token operator\">=</span>$<span class=\"token punctuation\">{</span>expires.toUTCString<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">path</span><span class=\"token operator\">=</span>/<span class=\"token variable\">`</span></span><span class=\"token punctuation\">;</span>\n\n      window.location.reload<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token operator\">&lt;</span>/script<span class=\"token operator\">></span>\n\n  <span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span>\n    You<span class=\"token string\">'re in the original build. Click here to use the preview! &lt;button onClick=\"preview()\">Let'</span>s <span class=\"token keyword\">do</span> it<span class=\"token operator\">&lt;</span>/button<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/html<span class=\"token operator\">></span></code></pre></div>\n<p>And here’s our fancy preview version:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/47d8b0c8158e03c886a54eff604f5848/20982/preview.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.054054054054056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAvUlEQVQY052PWQuDMBCE8///mBb7ZEnxwHgfeOD5JOqUXYjYh7bQhY/JbrLDRJjmDYZhwrLuKIoCTdMwaZqeeJ4H3/dZ9VlDfVmWWJYFeZ5DSPmEbT8gpUSWZWxKxHGMKIqQJAlc130zIRzH4TlpGIa8QyqUUtxQEnpAJrRAGgQBz+Z5RlVVqOua07Rti+M4TvZ9x7ZtrKLve4zjyNBXqSemaWLtug7rumIYBjbW+qkE/qxrwivi2+Uv9O61XlWcxxPF2uePAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Preview\"\n        title=\"Preview\"\n        src=\"/static/47d8b0c8158e03c886a54eff604f5848/fcda8/preview.png\"\n        srcset=\"/static/47d8b0c8158e03c886a54eff604f5848/12f09/preview.png 148w,\n/static/47d8b0c8158e03c886a54eff604f5848/e4a3f/preview.png 295w,\n/static/47d8b0c8158e03c886a54eff604f5848/fcda8/preview.png 590w,\n/static/47d8b0c8158e03c886a54eff604f5848/20982/preview.png 778w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">~❯ <span class=\"token function\">curl</span> -H <span class=\"token string\">\"x-preview: yes\"</span> http://example-load-balancer-55775428.us-east-1.elb.amazonaws.com\n<span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>script <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"text/javascript\"</span><span class=\"token operator\">></span>\n    const unpreview <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n      document.cookie <span class=\"token operator\">=</span> <span class=\"token string\">\"preview=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/\"</span><span class=\"token punctuation\">;</span>\n      window.location.reload<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token operator\">&lt;</span>/script<span class=\"token operator\">></span>\n\n  <span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span>\n    You're <span class=\"token keyword\">in</span> the preview build<span class=\"token operator\">!</span> <span class=\"token operator\">&lt;</span>button <span class=\"token assign-left variable\">onClick</span><span class=\"token operator\">=</span><span class=\"token string\">\"unpreview()\"</span><span class=\"token operator\">></span>Take me back<span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span>/button<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/html<span class=\"token operator\">></span></code></pre></div>\n<p>You can go back and forth ad nauseum. </p>\n<h2>Finishing up</h2>\n<blockquote>\n<p><i class=\"fas fa-check-circle\"></i> Be sure to delete your CloudFormation stack when you’re done</p>\n</blockquote>\n<p>You can update the containers independently through CloudFormation, so you could continually make\nimprovements to your preview version while the original stays in its well-known state.</p>\n<p>Once happy with the preview version, you’d want to update the original service to use the new\ncontainer version, and remove the ALB rules. The preview cookie wouldn’t cause any problems, For\nmore real-world usage, I’d suggest using something other than “yes” (like the new version name),\nto prevent cookie hoarders from accidentally opting in to something they didn’t mean to.</p>","frontmatter":{"title":"Opting in to Preview Builds with AWS ALBs","date":"April 27, 2020","description":null}}},"pageContext":{"slug":"/opt-in-previews-with-albs/","previous":{"fields":{"slug":"/iot-power-button/"},"frontmatter":{"title":"AWS IoT EC2 Power Button"}},"next":{"fields":{"slug":"/on-demand-windows-machine/"},"frontmatter":{"title":"On Demand Windows Machine in AWS"}}}}}